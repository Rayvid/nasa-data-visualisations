<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>MapBox Heatmap</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.css' rel='stylesheet' />
    <style>
      body {
        margin: 0;
        padding: 0;
      }

      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
	  
	  .mapcontrol {
		position: absolute;
		z-index: 10;
	  }
    </style>
	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
      $(() => {
		$("#datepicker").datepicker();
        $("#datepicker").datepicker("option", "dateFormat", "yy-mm-dd");
		var urlParams = new URLSearchParams(window.location.search);
		$("#datepicker").val(urlParams.get('date') || '2016-02-14');
		$("#datepicker").change(function() {
			var urlParams = new URLSearchParams(window.location.search);
			urlParams.delete('date');
			urlParams.append('date', $("#datepicker").val());
			window.location.href = 'mapbox.htm?' + urlParams.toString();
		});
      });
  </script>
</head>
<body>
  <div class="mapcontrol" style="top:20px;left:20px">
    Date:
	<input type="text" id="datepicker" size="30">
  </div>
	
  <div id='map'></div>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiYmFuYW5hc2EiLCJhIjoiY2sxd2gzb2RhMDFtbTNscGc4ZTljand5ayJ9.v5zgfYiieJkyambXSqo-Sw';
    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v10?optimize=true',
      center: [-118.22688, 34.06659],
      zoom: 8
    });

	map.on('load', function() {

	  map.addSource('trees', {
		type: 'geojson',
		data: 'http://34.252.164.246/geoJson/?query=SELECT%20Longitude,%20Latitude,%20MAX(Ozone)%20FROM%20Aerosols_cd%20WHERE%20toDate(DateTime)=toDate(\'' + $("#datepicker").val() + '\')%20GROUP%20BY%20toDate(DateTime),%20Longitude,%20Latitude%20LIMIT%2010000'
	});

	map.addLayer({
	  id: 'trees-heat',
	  type: 'heatmap',
	  source: 'trees',
	  maxzoom: 15,
	  paint: {
		// increase weight as diameter breast height increases
		'heatmap-weight': 1,
		// increase intensity as zoom level increases
		'heatmap-intensity': 1,
		// assign color values be applied to points depending on their density
		'heatmap-color': [
		  'interpolate',
		  ['linear'],
		  ['heatmap-density'],
		  0, 'rgba(0, 0, 255, 0)',
		  0.2, 'royalblue',
		  0.3, 'cyan',
		  0.5, 'lime',
		  0.7, 'yellow',
		  1, 'red'
		],
		// increase radius as zoom increases
		'heatmap-radius': [
			'interpolate',
			['linear'],
			['get','dbh'],
			200,
			10,
			300,
			20,
			400,
			30,
			500,
			40
		  ]
		,
		// decrease opacity to transition into the circle layer
		'heatmap-opacity': [
		  'interpolate',
		  ['linear'],
		  ['zoom'],
		  0,
		  0.5,
		  22,
		  0.9
		],
	  }
	}, 'waterway-label');

  // add circle layer here
	});


  </script>
</body>
</html>